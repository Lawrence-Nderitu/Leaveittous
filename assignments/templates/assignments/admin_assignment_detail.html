{% extends "landing_page/base.html" %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-gray-300">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 break-all" title="{{ assignment.title }}">{{ page_title }}</h1>
        <div class="mt-2 md:mt-0">
            <a href="{% url 'assignments:admin_list_assignments' %}" class="text-blue-600 hover:text-blue-800 text-sm mr-4 inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                Back to Assignments List
            </a>
            <a href="{% url 'users:admin_dashboard' %}" class="text-gray-600 hover:text-gray-800 text-sm inline-flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5M12 15.75h.008v.015H12v-.015z" /></svg>
                Admin Dashboard
            </a>
        </div>
    </div>

    <!-- Main Assignment Details Card -->
    <div class="bg-white shadow-xl rounded-lg p-6 mb-8 border border-gray-200">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
            <div>
                <h3 class="text-sm font-medium text-gray-500">Title</h3>
                <p class="mt-1 text-md text-gray-900">{{ assignment.title }}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500">Status</h3>
                <p class="mt-1 text-md">
                    {% if assignment.status == 'completed' %}<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{{ assignment.get_status_display }}</span>
                    {% elif assignment.status == 'submitted' %}<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">{{ assignment.get_status_display }}</span>
                    {% elif assignment.status == 'assigned' %}<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ assignment.get_status_display }}</span>
                    {% elif assignment.status == 'open' %}<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">{{ assignment.get_status_display }}</span>
                    {% else %}<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">{{ assignment.get_status_display }}</span>{% endif %}
                </p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500">Student</h3>
                <p class="mt-1 text-md text-gray-900">{{ assignment.student.username }} ({{ assignment.student.email }})</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500">Assigned Writer</h3>
                <p class="mt-1 text-md text-gray-900">{{ assignment.writer.username|default:"N/A" }} {% if assignment.writer %}({{ assignment.writer.email }}){% endif %}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500">Deadline</h3>
                <p class="mt-1 text-md text-gray-900">{{ assignment.deadline|date:"Y-m-d H:i" }}</p>
            </div>
            <div>
                <h3 class="text-sm font-medium text-gray-500">Budget</h3>
                <p class="mt-1 text-md text-gray-900">${{ assignment.budget }}</p>
            </div>
            <div class="md:col-span-2 lg:col-span-3">
                <h3 class="text-sm font-medium text-gray-500">Description</h3>
                <p class="mt-1 text-md text-gray-900 whitespace-pre-line">{{ assignment.description }}</p>
            </div>

            {% if assignment.requirement_file_1 or assignment.requirement_file_2 %}
            <div class="md:col-span-3 lg:col-span-3 mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-500 mb-1">Requirement Files Uploaded by Student:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    {% if assignment.requirement_file_1 %}
                        <li>
                            <a href="{{ assignment.requirement_file_1.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                                {{ assignment.requirement_file_1.name|cut:"assignment_requirements/%Y/%m/%d/"|default:assignment.requirement_file_1.name }} (File 1)
                            </a>
                        </li>
                    {% endif %}
                    {% if assignment.requirement_file_2 %}
                        <li>
                            <a href="{{ assignment.requirement_file_2.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                                {{ assignment.requirement_file_2.name|cut:"assignment_requirements/%Y/%m/%d/"|default:assignment.requirement_file_2.name }} (File 2)
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}

            <div class="text-sm text-gray-500 lg:col-span-3 mt-4 pt-4 border-t border-gray-200">
                Posted: {{ assignment.created_at|date:"Y-m-d H:i" }} | Last Updated: {{ assignment.updated_at|date:"Y-m-d H:i" }}
            </div>
        </div>
        <div class="mt-6 border-t pt-4">
             <a href="{% url 'admin:assignments_assignment_change' assignment.id %}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium inline-flex items-center" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                Edit in Django Admin
            </a>
        </div>
    </div>

    <!-- Submission Details Card -->
    {% if assignment.submitted_at %}
    <div class="bg-white shadow-xl rounded-lg p-6 mb-8 border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">Submission Details</h2>
        <p class="mb-2"><strong>Submitted At:</strong> {{ assignment.submitted_at|date:"Y-m-d H:i" }}</p>
        {% if assignment.submitted_work %}
            <p class="mb-2"><strong>Submitted File:</strong>
                <a href="{{ assignment.submitted_work.url }}" download class="text-blue-500 hover:text-blue-700 hover:underline inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    {{ assignment.submitted_work.name|cut:"submissions/%Y/%m/%d/" }}
                </a>
            </p>
        {% else %}
            <p class="text-gray-600">No file was submitted.</p>
        {% endif %}
        <p><strong>Notes:</strong></p>
        <p class="text-gray-800 whitespace-pre-line p-3 bg-gray-50 rounded-md border">{{ assignment.submission_notes|default:"N/A" }}</p>
    </div>
    {% endif %}

    <!-- Student Review Card -->
    {% if assignment.rating or assignment.review_comments %}
    <div class="bg-white shadow-xl rounded-lg p-6 mb-8 border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">Student Review</h2>
        <p class="mb-2"><strong>Rating:</strong>
            {% if assignment.rating %}
                <span class="text-yellow-500 font-bold">{{ assignment.rating }}/5 Stars</span>
            {% else %}
                <span class="text-gray-500">Not yet rated.</span>
            {% endif %}
        </p>
        <p><strong>Comments:</strong></p>
        <p class="text-gray-800 whitespace-pre-line p-3 bg-gray-50 rounded-md border">{{ assignment.review_comments|default:"No comments provided." }}</p>
    </div>
    {% endif %}

    <!-- Bids Section -->
    <div class="bg-white shadow-xl rounded-lg p-6 border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Bids for this Assignment ({{ bids.count }})</h2>
        {% if bids %}
            <div class="space-y-4">
                {% for bid in bids %}
                <div class="border rounded-md p-4 {% if bid.status == 'accepted' %}bg-green-50 border-green-200{% elif bid.status == 'rejected' %}bg-red-50 border-red-200{% else %}bg-gray-50 border-gray-200{% endif %}">
                    <div class="flex justify-between items-start">
                        <h3 class="font-semibold text-md">Bid by: <span class="text-blue-600">{{ bid.writer.username }}</span></h3>
                        <p class="text-lg font-bold text-emerald-600">${{ bid.amount }}</p>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Placed on: {{ bid.created_at|date:"Y-m-d H:i" }}</p>
                    <p class="text-sm text-gray-600">Status:
                        <span class="font-medium
                            {% if bid.status == 'accepted' %}text-green-700{% elif bid.status == 'rejected' %}text-red-700{% else %}text-yellow-700{% endif %}">
                            {{ bid.get_status_display|capfirst }}
                        </span>
                    </p>
                    <div class="mt-2">
                        <strong class="text-sm text-gray-600">Proposal:</strong>
                        <p class="text-gray-700 mt-1 whitespace-pre-line p-2 bg-white rounded border text-sm">{{ bid.proposal|truncatewords_html:50 }}</p>
                    </div>
                     <div class="mt-2">
                        <a href="{% url 'admin:assignments_bid_change' bid.id %}" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium inline-flex items-center" target="_blank">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                            Edit Bid
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">No bids were placed for this assignment.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
